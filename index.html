<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Live Vliegtuigen - OpenSky Smooth</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map {
      height: 100vh;
      width: 100vw;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([20, 0], 2); // start: wereldbeeld
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let planes = {}; // vliegtuigen per icao24

    // icoon generator
    function createPlaneIcon(rotation, zoom) {
      const size = Math.max(12, zoom * 2);
      return L.divIcon({
        className: '',
        html: `
          <svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" 
               viewBox="0 0 24 24" fill="black" stroke="black" stroke-width="2"
               style="transform: rotate(${rotation}deg); transform-origin: center;">
            <path d="M2.5 19l19.5-7L2.5 5v5l10 2-10 2z"/>
          </svg>
        `,
        iconSize: [size, size],
        iconAnchor: [size/2, size/2]
      });
    }

    // fetch vliegtuigen elke 5 seconden
    async function fetchPlanes() {
      const url = "https://opensky-network.org/api/states/all";
      const zoom = map.getZoom();
      const now = Date.now();

      try {
        const response = await fetch(url);
        const data = await response.json();

        if (data.states) {
          const activeIcao = new Set();

          data.states.forEach(state => {
            const icao24 = state[0];
            const callsign = state[1];
            const lon = state[5];
            const lat = state[6];
            const velocity = state[9];
            const track = state[10];

            if (lat && lon) {
              activeIcao.add(icao24);

              if (!planes[icao24]) {
                // nieuw vliegtuig
                const marker = L.marker([lat, lon], { icon: createPlaneIcon(track || 0, zoom) })
                  .bindPopup(`<b>${callsign || "Onbekend"}</b><br>
                              Snelheid: ${Math.round(velocity)} m/s<br>
                              Heading: ${track || "?"}°`)
                  .addTo(map);

                planes[icao24] = {
                  marker,
                  lastTrack: track || 0,
                  start: { lat, lon, time: now },
                  end: { lat, lon, time: now + 5000 }
                };
              } else {
                // update target positie
                planes[icao24].start = {
                  lat: planes[icao24].end.lat,
                  lon: planes[icao24].end.lon,
                  time: now
                };
                planes[icao24].end = { lat, lon, time: now + 5000 };

                const icon = createPlaneIcon(track || planes[icao24].lastTrack, zoom);
                planes[icao24].marker.setIcon(icon);
                planes[icao24].lastTrack = track || planes[icao24].lastTrack;
              }
            }
          });

          // verwijder vliegtuigen die niet meer actief zijn
          for (let id in planes) {
            if (!activeIcao.has(id)) {
              map.removeLayer(planes[id].marker);
              delete planes[id];
            }
          }
        }
      } catch (err) {
        console.error("Fout bij ophalen data:", err);
      }
    }

    // animatie loop voor interpolatie
    function animate() {
      const now = Date.now();
      const zoom = map.getZoom();

      for (let id in planes) {
        const p = planes[id];
        const { start, end } = p;

        const progress = Math.min(1, (now - start.time) / (end.time - start.time));
        const lat = start.lat + (end.lat - start.lat) * progress;
        const lon = start.lon + (end.lon - start.lon) * progress;

        p.marker.setLatLng([lat, lon]);
        // update icon grootte bij zoom
        p.marker.setIcon(createPlaneIcon(p.lastTrack, zoom));
      }

      requestAnimationFrame(animate);
    }

    // start
    fetchPlanes();
    setInterval(fetchPlanes, 5000);
    animate();

    // bij zoom → iconen schalen
    map.on("zoomend", () => {
      const zoom = map.getZoom();
      for (let id in planes) {
        planes[id].marker.setIcon(createPlaneIcon(planes[id].lastTrack, zoom));
      }
    });
  </script>
</body>
</html>
